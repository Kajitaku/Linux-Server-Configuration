# Linux Server Configuration

Let's deploy Flask on Amazon light sail.

## Server environment
- service: Amazon light sail
- os: ubuntu 16.04
- apache: ver 2.4.18
- python: ver 2.7.12
- Flask: ver 1.0.2
- Postgresql: ver 9.5.13
- Public ip: [13.231.224.90](http://13.231.224.90/)

## Setting instance
First, I tried to change language from Japanese to Engilish.
But I couldn't. Please forgive me.

1. Click `create instance`.
![](images/1.png)

1. Select `Linux/Unix` platform. And select `Ubuntu`.
![](images/2.png)
1. Then click `create` button in the same page.
![](images/3.png)

1. After instance is ready, access ssh key page from link around bottom in connection tab.
![](images/4.png)

1. Click `Download` to get ssh private key.
![](images/5.png)

## SSH connection
In my case, the key file name is `LightsailDefaultPrivateKey-ap-northeast-1.pem`.
And to login by ssh, run these commands in client pc.
`chmod 400 LightsailDefaultPrivateKey-ap-northeast-1.pem`
`ssh ubuntu@your_public_ip -i LightsailDefaultPrivateKey-ap-northeast-1.pem`

## Change ssh port to 2200
1. In firewall setting in the page, add new custom rule like this.
![](images/6.png)

1. Change port in sshd_config file.
`sudo vi /etc/ssh/sshd_config`
```diff
# What ports, IPs and protocols we listen for
-Port 22
+Port 2200
```
`sudo service ssh restart` to update change.

## Configure Firewall
```
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 2200/tcp
sudo ufw allow www
sudo ufw allow ntp
sudo ufw enable
```
ufw status is
```
Status: active

To                         Action      From
--                         ------      ----
2200/tcp                   ALLOW       Anywhere                  
80/tcp                     ALLOW       Anywhere                  
123                        ALLOW       Anywhere                  
2200/tcp (v6)              ALLOW       Anywhere (v6)             
80/tcp (v6)                ALLOW       Anywhere (v6)             
123 (v6)                   ALLOW       Anywhere (v6) 
```

## Give grader access

1. Add grader user
`sudo adduser grader`
1. Add sudo permission to grader
`sudo cp /etc/sudoers.d/90-cloud-init-users /etc/sudoers.d/grader`
`sudo visudo -f /etc/sudoers.d/grader`
```diff
-# User rules for ubuntu
+# User rules for grader
-ubuntu ALL=(ALL) NOPASSWD:ALL
+grader ALL=(ALL) NOPASSWD:ALL

```

**Add sshkey to grader's authorize_key**
1. Generate sshkey for grader in client pc.
`ssh-keygen`

1. In lightsail server, login as grader from ubuntu user.
`sudo login grader`

1. Add public ssh key generated by ssh-keygen into /home/grader/.ssh/authorized_keys
`mkdir ~/.ssh`
`vi ~/.ssh/authorized_keys` and paste pubic sshkey in this file.
`chmod 700 ~/.ssh`
`chmod 644 ~/.ssh/authorized_keys`

## Prepare to deploy your project
### Update libraries
`sudo apt-get update -y`
`sudo apt-get upgrade -y`

### Configure the local timezone to UTC
`sudo dpkg-reconfigure tzdata`
Select none of the above and select UTC.

### Install applications and modules
1. login lightsail server as ubuntu user.
1. Install these with following commands.
`sudo apt-get install -y python-dev python-pip git apache2 postgresql libapache2-mod-wsgi`
`sudo pip install flask sqlalchemy oauth2client requests psycopg2 psycopg2-binary`
When pip install, if this error message is shown,
`locale.Error: unsupported locale setting`
run this command.
`export LC_ALL=C`
And sometimes, despite of already installed by pip, following error message is outputted.
`ImportError: No module named â€¦`
Then run this.
`sudo -H pip install module_name`
1. Get source code.
`cd /var/www/html`
`sudo git clone https://github.com/Kajitaku/ud_item_catalog.git`

## Setting apache
When apache communicates flask, .wsgi file connects each others.
1. So put it into ud_item_catalog folder.
`sudo vi /var/www/html/ud_item_catalog/app.wsgi`
```
import sys
sys.path.insert(0, '/var/www/html/ud_item_catalog')
from project import app as application
application.secret_key='super_secret_key'
```
1. and to execute the file, modify apache setting file.
`sudo vi /etc/apache2/sites-enabled/000-default.conf`
```diff
-DocumentRoot /var/www/html/
+DocumentRoot /var/www/html/ud_item_catalog
+WSGIDaemonProcess ud_item_catalog user=www-data group=www-data threads=5
+WSGIScriptAlias / /var/www/html/ud_item_catalog/app.wsgi
+WSGIScriptReloading On
```
1. `sudo apache2ctl restart` to update setting.

## Setting Postgresql
1. Check not allow remote connections
`sudo vi /etc/postgresql/9.5/main/pg_hba.conf`
If around bottom config in this file, a `ADDRESS` is global ip and `METHOD` is `trust`, it may means being enable connecting remotely.

1. Create a new database user named catalog
`sudo -u postgres createuser -P catalog` and set passward.
1. Create catalog application database with limited permissions.
`sudo -u postgres createdb -O catalog catalog`
1. Start postgresql
`sudo /etc/init.d/postgresql start`


## Modify project environment path
1. Change sqlite3 to postgres.
`sudo vi /var/www/html/ud_item_catalog/project.py`
`sudo vi /var/www/html/ud_item_catalog/database_setup.py`
`sudo vi /var/www/html/ud_item_catalog/lotspfmenus.py`
```diff
-engine = create_engine('sqlite:///catalogapp.db')
+engine = create_engine('postgresql://catalog:PASSWORD@localhost/catalog')
```

2. Initialize database
`python /var/www/html/ud_item_catalog/database_setup.py`
`python /var/www/html/ud_item_catalog/lotsofmenus.py`

3. Change `client_secrets.json` path to absolute.
```diff
-open('client_secrets.json', 'r').read())['web']['client_id']

+open('/var/www/html/ud_item_catalog/client_secrets.json', 'r').read())['web']['client_id']

```

## All done!!
Let's try to see [URL](http://13.231.224.90/).